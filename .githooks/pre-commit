#!/usr/bin/env bash
set -euo pipefail

# Load nvm if available
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

echo "Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Check if any API files changed
API_FILES=$(echo "$STAGED_FILES" | grep -E '^lumentra-api/.*\.(ts|tsx)$' || true)

# Check if any dashboard files changed
DASHBOARD_FILES=$(echo "$STAGED_FILES" | grep -E '^lumentra-dashboard/.*\.(ts|tsx)$' || true)

# Format with prettier
FORMAT_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|md|css|scss|yaml|yml)$' || true)
if [ -n "$FORMAT_FILES" ]; then
  echo -e "${YELLOW}Formatting files with Prettier...${NC}"
  echo "$FORMAT_FILES" | xargs npx --yes prettier@3.3.3 --write
  echo "$FORMAT_FILES" | xargs git add
fi

# Type check API
if [ -n "$API_FILES" ]; then
  echo -e "${YELLOW}Type checking lumentra-api...${NC}"
  if ! (cd lumentra-api && npm run typecheck 2>/dev/null); then
    echo -e "${RED}API type check failed!${NC}"
    exit 1
  fi
  echo -e "${GREEN}API type check passed${NC}"
fi

# Type check and lint dashboard
if [ -n "$DASHBOARD_FILES" ]; then
  echo -e "${YELLOW}Type checking lumentra-dashboard...${NC}"
  if ! (cd lumentra-dashboard && npx tsc --noEmit 2>/dev/null); then
    echo -e "${RED}Dashboard type check failed!${NC}"
    exit 1
  fi
  echo -e "${GREEN}Dashboard type check passed${NC}"

  echo -e "${YELLOW}Linting staged dashboard files...${NC}"
  # Only lint staged files, not entire codebase
  STAGED_DASHBOARD=$(echo "$DASHBOARD_FILES" | sed 's|lumentra-dashboard/||g' | tr '\n' ' ')
  if [ -n "$STAGED_DASHBOARD" ]; then
    if ! (cd lumentra-dashboard && npx eslint $STAGED_DASHBOARD 2>/dev/null); then
      echo -e "${RED}Dashboard lint failed!${NC}"
      exit 1
    fi
  fi
  echo -e "${GREEN}Dashboard lint passed${NC}"
fi

# Check for secrets/env files
SECRETS=$(echo "$STAGED_FILES" | grep -E '\.env$|\.env\.local$|credentials|secret' || true)

if [ -n "$SECRETS" ]; then
  echo -e "${RED}WARNING: Attempting to commit potential secrets:${NC}"
  echo "$SECRETS"
  echo -e "${RED}Remove these files from staging or add to .gitignore${NC}"
  exit 1
fi

echo -e "${GREEN}All pre-commit checks passed!${NC}"
